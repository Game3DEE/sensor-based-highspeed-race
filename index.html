<!doctype html>
<html lang="en">
<head>
<title>Test von Web GL</title>
<meta charset="utf-8">
</head>
<body style="margin: 0;">
 
<script src="js/three.min.js"></script>
<script src="js/OrbitControls.js"></script>
<script src="js/ColladaLoader.js"></script>

<script src="js/BinaryLoader.js"></script>
<script src="js/Cars.js"></script>
<script src="js/Detector.js"></script>
<script src="js/stats.min.js"></script>

<script type="text/javascript" src="js/physi.js"></script>

<script type="text/javascript">
	if ( ! Detector.webgl ) Detector.addGetWebGLMessage();
	'use strict';

    Physijs.scripts.worker = '/js/physijs_worker.js';
    Physijs.scripts.ammo = '/js/ammo.js';

    var initScene, render, renderer, scene, box, mlib, vehicle;
	var config = {
		"veyron"	: { r: 0.5,	 model: null, backCam: new THREE.Vector3( 550, 100, -1000 ) }
	};
	
	var camera, light;
	
	var SCREEN_WIDTH = window.innerWidth;
	var SCREEN_HEIGHT = window.innerHeight;

    initScene = function() {
        renderer = new THREE.WebGLRenderer({ antialias: true });
		renderer.shadowMapEnabled = true;
		renderer.shadowMapSoft = true;
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.getElementById( 'viewport' ).appendChild( renderer.domElement );

		scene = new Physijs.Scene;
		scene.setGravity(new THREE.Vector3( 0, -30, 0 ));
		
		camera = new THREE.PerspectiveCamera(
			35,
			window.innerWidth / window.innerHeight,
			1,
			5000
		);
		scene.add( camera );

		// Skybox
		var imagePrefix = "images/dawnmountain-";
		var directions  = ["xpos", "xneg", "ypos", "yneg", "zpos", "zneg"];
		var imageSuffix = ".png";
		var skyGeometry = new THREE.BoxGeometry( 5000, 5000, 5000 );	
		var materialArray = [];
		for (var i = 0; i < 6; i++)
			materialArray.push( new THREE.MeshBasicMaterial({
				map: THREE.ImageUtils.loadTexture( imagePrefix + directions[i] + imageSuffix ),
				side: THREE.BackSide
			}));
		var skyMaterial = new THREE.MeshFaceMaterial( materialArray );
		var skyBox = new THREE.Mesh( skyGeometry, skyMaterial );
		scene.add( skyBox );

		// Ground
		ground_material = Physijs.createMaterial(
			new THREE.MeshLambertMaterial({ map: THREE.ImageUtils.loadTexture( 'models/Grass_256.png' ) }),
			1, // high friction
			1 // low restitution
		);
		ground_material.map.wrapS = ground_material.map.wrapT = THREE.RepeatWrapping;
		ground_material.map.repeat.set( 100, 100 );

		var ground_geometry = new THREE.PlaneGeometry( 5000, 5000, 5000 );
		ground_geometry.computeFaceNormals();
		ground_geometry.computeVertexNormals();

		// If your plane is not square as far as face count then the HeightfieldMesh
		// takes two more arguments at the end: # of x faces and # of z faces that were passed to THREE.PlaneMaterial
		ground = new Physijs.BoxMesh(
				ground_geometry,
				ground_material,
				0 // mass
		);
		ground.rotation.x = -Math.PI / 2;
		ground.receiveShadow = true;
		ground.position.set(0, -1, 0);
		scene.add( ground );

		// Light
		light = new THREE.DirectionalLight( 0xFFFFFF );
		light.position.set( 20, 20, -15 );
		light.target.position.copy( scene.position );
		light.castShadow = true;
		light.shadowCameraLeft = -150;
		light.shadowCameraTop = -150;
		light.shadowCameraRight = 150;
		light.shadowCameraBottom = 150;
		light.shadowCameraNear = 20;
		light.shadowCameraFar = 400;
		light.shadowBias = -.0001
		light.shadowMapWidth = light.shadowMapHeight = 2048;
		light.shadowDarkness = .7;
		scene.add( light );
		
		// Strecke
		
		var loader = new THREE.JSONLoader();
		 
		loader.load( 'models/MountainTrack/MountainValley_Track.js', function ( track, track_materials ) {
			var mesh = new Physijs.ConcaveMesh(
				track,
			   Physijs.createMaterial(
					new THREE.MeshFaceMaterial( track_materials ),
					1.0, // friction
					1.0 // restitution
					),0 //mass
			);
			mesh.receiveShadow = true;
			scene.add(mesh);	
		});
		
		// Car
		// FLARES

		flareA = THREE.ImageUtils.loadTexture( "textures/lensflare2.jpg" );
		flareB = THREE.ImageUtils.loadTexture( "textures/lensflare0.png" );
		
		// MATERIALS

		var selectedCar = new Cars("gallardo");
		//controls
		controls = new THREE.OrbitControls(camera, renderer.domElement);
        requestAnimationFrame( render );
		scene.simulate(); // run physics
    };

    render = function() {
		requestAnimationFrame( render );
		if ( vehicle ) {
			camera.position.copy( vehicle.mesh.position ).add( new THREE.Vector3( 20, 15, -50 ) );
			camera.lookAt( vehicle.mesh.position );
			light.target.position.copy( vehicle.mesh.position );
			light.position.addVectors( light.target.position, new THREE.Vector3( 20, 20, -15 ) );
		}
		renderer.render( scene, camera); // render the scene
	};
	
    window.onload = initScene;

    </script>
</head>

<body>
    <div id="viewport"></div>
</body>
</html>