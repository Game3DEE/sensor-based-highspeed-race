<!doctype html>
<html lang="en">
<head>
<title>Test von Web GL</title>
<meta charset="utf-8">
</head>
<body style="margin: 0;">
 
<script src="js/three.min.js"></script>
<script src="js/OrbitControls.js"></script>
<script src="js/ColladaLoader.js"></script>

<script src="js/BinaryLoader.js"></script>
<script src="js/Cars.js"></script>
<script src="js/Detector.js"></script>
<script src="js/stats.min.js"></script>

<script type="text/javascript" src="js/physi.js"></script>

<script type="text/javascript" src="js/speedometer/speedometer.js"></script>
<script type="text/javascript" src="js/speedometer/themes/default.js"></script>
<script type="text/javascript" src="js/speedometer/digitaldisplay.js"></script>
<script type="text/javascript" src="js/speedometer/example.js"></script>
<script type="text/javascript" src="js/speedometer/tbe.js"></script>
<script type="text/javascript" src="js/speedometer/xcanvas.js"></script>
<link rel="stylesheet" type="text/css" href="css/style.css" media="screen" />

<script type="text/javascript" src="js/jquery.js"></script>

<script type="text/javascript" src="js/timer.js"></script>

<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

<script type="text/javascript">
	if ( ! Detector.webgl ) Detector.addGetWebGLMessage();
	'use strict';
	
	var speedometer;
	var start = 0;
	document.addEventListener ("DOMContentLoaded", function() {
	  document.removeEventListener ("DOMContentLoaded", arguments.callee, false);

	  speedometer = new Speedometer ('speedometer', {theme: 'default', max: 200.0});
	  speedometer.draw ();
	  tachometer = new Speedometer ('tachometer', {theme: 'default', max: 7000.0});
	  tachometer.draw ();
	});
    Physijs.scripts.worker = 'js/physijs_worker.js';
    Physijs.scripts.ammo = 'ammo.js';
    var initScene, render, renderer, scene, box, mlib, radarCamera, selectedCar;
	var vehicle, raceTrack, cameraTarget;
	var $trackingOverlay = $('#tracking-overlay');
	
	var camera, light;
	var projector;
	var timer;
	
	var SCREEN_WIDTH = window.innerWidth;
	var SCREEN_HEIGHT = window.innerHeight;
    initScene = function() {
		cameraTarget = new THREE.Vector3();
		projector = new THREE.Projector();
        renderer = new THREE.WebGLRenderer({ antialias: true });
		renderer.shadowMapEnabled = true;
		renderer.shadowMapSoft = true;
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById( 'viewport' ).appendChild( renderer.domElement );

		scene = new Physijs.Scene;
		scene.setGravity(new THREE.Vector3( 0, -30, 0 ));
		camera = new THREE.PerspectiveCamera(
			35,
			window.innerWidth / window.innerHeight,
			1,
			5000
		);
		
		radarCamera = new THREE.PerspectiveCamera(
			35,
			900 / 500,
			1,
			5000
		);
		scene.add( radarCamera );
		
		radarCamera.position.set(0,1500,0);
		radarCamera.lookAt( scene.position )

		// Skybox
		var imagePrefix = "images/dawnmountain-";
		var directions  = ["xpos", "xneg", "ypos", "yneg", "zpos", "zneg"];
		var imageSuffix = ".png";
		var skyGeometry = new THREE.BoxGeometry( 5000, 5000, 5000 );	
		var materialArray = [];
		for (var i = 0; i < 6; i++)
			materialArray.push( new THREE.MeshBasicMaterial({
				map: THREE.ImageUtils.loadTexture( imagePrefix + directions[i] + imageSuffix ),
				side: THREE.BackSide
			}));
		var skyMaterial = new THREE.MeshFaceMaterial( materialArray );
		var skyBox = new THREE.Mesh( skyGeometry, skyMaterial );
		scene.add( skyBox );

		// Ground
		ground_material = Physijs.createMaterial(
			new THREE.MeshLambertMaterial({ map: THREE.ImageUtils.loadTexture( 'models/tracks/MountainTrack/Grass_256.png' ) }),
			1, // high friction
			1 // low restitution
		);
		ground_material.map.wrapS = ground_material.map.wrapT = THREE.RepeatWrapping;
		ground_material.map.repeat.set( 100, 100 );

		var ground_geometry = new THREE.PlaneGeometry( 5000, 5000, 5000 );
		ground_geometry.computeFaceNormals();
		ground_geometry.computeVertexNormals();

		// If your plane is not square as far as face count then the HeightfieldMesh
		// takes two more arguments at the end: # of x faces and # of z faces that were passed to THREE.PlaneMaterial
		ground = new Physijs.BoxMesh(
				ground_geometry,
				ground_material,
				0 // mass
		);
		ground.rotation.x = -Math.PI / 2;
		ground.receiveShadow = true;
		ground.position.set(0, -1, 0);
		scene.add( ground );

		// Light
		light = new THREE.DirectionalLight( 0xFFFFFF );
		light.position.set( 20, 20, -15 );
		light.target.position.copy( scene.position );
		light.castShadow = true;
		light.shadowCameraLeft = -150;
		light.shadowCameraTop = -150;
		light.shadowCameraRight = 150;
		light.shadowCameraBottom = 150;
		light.shadowCameraNear = 20;
		light.shadowCameraFar = 400;
		light.shadowBias = -.0001
		light.shadowMapWidth = light.shadowMapHeight = 2048;
		light.shadowDarkness = .7;
		scene.add( light );
		
		// Strecke
		
		var loader = new THREE.JSONLoader();
		 
		loader.load( 'models/tracks/MountainTrack/MountainValley_Track.js', function ( track, track_materials ) {
			raceTrack = new Physijs.ConcaveMesh(
				track,
			   Physijs.createMaterial(
					new THREE.MeshFaceMaterial( track_materials ),
					1.0, // friction
					1.0 // restitution
					),0 //mass
			);
			raceTrack.receiveShadow = true;
			scene.add(raceTrack);	
		});
		
		// Car
		// FLARES

		flareA = THREE.ImageUtils.loadTexture( "textures/lensflare2.jpg" );
		flareB = THREE.ImageUtils.loadTexture( "textures/lensflare0.png" );
		
		// MATERIALS
		window.addEventListener( 'resize', onWindowResize, false );
		selectedCar = new Cars("mustang");
		cameraTarget.z = 500;
		cameraTarget.y = 0;
		camera.position.y = 2;
		camera.position.z = -3;
		camera.lookAt( cameraTarget );
        requestAnimationFrame( render );
		scene.simulate(); // run physics
    };

    render = function() {
		requestAnimationFrame( render );
		if ( vehicle ) {
			light.target.position.copy( vehicle.mesh.position );
			light.position.addVectors( light.target.position, new THREE.Vector3( 20, 20, -15 ) );
			positionTrackingOverlay();
			camera.lookAt( cameraTarget );
			if(!timer)
				timer = new Timer();
			timer.updateTimer(vehicle);
		}
		renderer.render( scene, camera); // render the scene
	};
	
    window.onload = initScene;
	
	positionTrackingOverlay = function()
	{
		var matrix = vehicle.mesh.world.matrixWorld;
		var visibleWidth, visibleHeight, p, v, percX, percY, left, top;
		// perspective:
		// this will give us position relative to the world
		var position = new THREE.Vector3();
		position.applyMatrix4( vehicle.mesh.matrixWorld );
		p = position.clone();
		// projectVector will translate position to 2d
		v = projector.projectVector(p, radarCamera);

		percX = (v.x + 1) / 2;
		percY = (-v.y + 1) / 2;

		left = percX * SCREEN_WIDTH;
		top = percY * SCREEN_HEIGHT;

		widthPercentage = (left - $(".tracking-ball").width() / 2) / SCREEN_WIDTH * 100;
		heightPercentage = (top - $(".tracking-ball").height() / 2) / SCREEN_HEIGHT * 100;
		$(".tracking-ball")
			.css('left', widthPercentage + '%')
			.css('top', heightPercentage + '%');
	};
	
	function onWindowResize( event ) {

		SCREEN_WIDTH = window.innerWidth;
		SCREEN_HEIGHT = window.innerHeight;


		renderer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );

	}
    </script>
</head>

<body>
	<div id="timer">00:00:000</div>
	<div id="tacho">
		<div id="speedometer"></div>
		<div id="tachometer"></div>
	</div>
    <div id="viewport">
		<div id="tracking-overlay">
			<img src="images/MountainTrack.png">
			<div class="tracking-ball"></div>
		</div>
	</div>
</body>
</html>